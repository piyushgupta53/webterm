<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Test</title>
  </head>
  <body>
    <h1>WebSocket Test</h1>
    <div>
      <label>Session ID: </label>
      <input type="text" id="sessionId" placeholder="Enter session ID" />
      <button onclick="connect()">Connect</button>
      <button onclick="disconnect()">Disconnect</button>
    </div>
    <div>
      <input type="text" id="inputText" placeholder="Enter command" />
      <button onclick="sendInput()">Send</button>
    </div>
    <div>
      <h3>Output:</h3>
      <pre
        id="output"
        style="
          background: #000;
          color: #0f0;
          padding: 10px;
          height: 300px;
          overflow-y: scroll;
        "
      ></pre>
    </div>
    <div>
      <h3>Status:</h3>
      <div id="status">Disconnected</div>
    </div>

    <script>
      let ws = null;
      let sessionId = "";

      function connect() {
        sessionId = document.getElementById("sessionId").value;
        if (!sessionId) {
          alert("Please enter a session ID");
          return;
        }

        const wsUrl = `ws://localhost:8080/ws?session=${sessionId}`;
        console.log("Connecting to:", wsUrl);

        ws = new WebSocket(wsUrl);

        ws.onopen = function (event) {
          console.log("WebSocket connected");
          document.getElementById("status").textContent = "Connected";
        };

        ws.onmessage = function (event) {
          const message = JSON.parse(event.data);
          console.log("Received message:", message);

          if (message.type === "output") {
            const output = document.getElementById("output");
            output.textContent += message.data;
            output.scrollTop = output.scrollHeight;
          } else if (message.type === "status") {
            document.getElementById(
              "status"
            ).textContent = `Connected - Session Status: ${message.status}`;
          } else if (message.type === "error") {
            document.getElementById(
              "status"
            ).textContent = `Error: ${message.error}`;
          }
        };

        ws.onclose = function (event) {
          console.log("WebSocket disconnected");
          document.getElementById("status").textContent = "Disconnected";
        };

        ws.onerror = function (error) {
          console.error("WebSocket error:", error);
          document.getElementById("status").textContent = "Error";
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
        }
      }

      function sendInput() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          alert("WebSocket not connected");
          return;
        }

        const input = document.getElementById("inputText").value;
        if (!input) return;

        const message = {
          type: "input",
          data: input + "\n",
          timestamp: new Date().toISOString(),
        };

        ws.send(JSON.stringify(message));
        document.getElementById("inputText").value = "";
      }

      // Send input on Enter key
      document
        .getElementById("inputText")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendInput();
          }
        });
    </script>
  </body>
</html>
